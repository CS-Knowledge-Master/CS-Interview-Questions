### 2) 컨텍스트 스위칭 ( Context Switching )에 대해
설명해주세요.

- CPU가 한 프로세스에서 다른 프로세스로 전환할 때 발생하는 일련의 과정

의역 : 문맥을 교환한다. CPU가 특정 프로세스를 실행하는 맥락을 바꾼다.
맥락의 교환하는 것을 알려야하는 주체는? OS, CPU. 이는 각각 PCB의 변환, CPU-RAM 간의 캐시 메모리 구조를 재설정해줘야함을 의미한다. 이것이 Overhead로 이어짐.

- 목적 : 여러 개의 프로세스를 번갈아 실행하며, 프로세스의 응답률을 높인다. CPU의 활용률을 높인다.

- 동작과정 :

1) 실행중이던 프로세스가 대기를 한다. ( Running → Waiting )

2) 해당 프로세스의 상태( Context )를 보관하고, 대기하고 있던 다음 순서의 프로세스가 동작하면서 이전에 보관했던 프로세스의 상태를 복구한다.

---

### PCB ( Process Control Block )

- 운영체제에서 프로세스를 관리하기 위해, 해당 프로세스의 상태 정보를 담고 있는 자료구조이다.

- PCB는 프로세스 스케줄링을 위해 프로세스에 관한 모든 정보를 저장하는 임시 저장소이다.

- OS는 PCB에 담긴 프로세스의 고유 정보를 통해 프로세스를 관리한다. 즉, 이 자료들을 통해 프로세스의 실행 상태 파악, 우선순위 조정, 스케줄링 수행, 다른 프로세스와의 동기화를 제어한다.

- PCB 구성요소 ( OS마다 다르지만 일반적으로 )
    - 포인터 ( Pointer ) : 프로세스의 현재 위치 저장 포인터 정보 ( = 프로세스를 Running 상태로 만들기 위해 필요 )
    - 프로세스 상태 ( Procecss State ) : 프로세스의 각 상태
    - 프로세스 아이디 ( PID ) : 프로세스 식별자를 지정하는 고유한 ID
    - 프로그램 카운터 ( Program Counter ) : 프로세스를 위해 실행될 다음 명령어의 주소를 포함하는 카운터 저장
    - 레지스터 ( Register ) : 누산기. 베이스, 레지스터 및 범용 레지스터를 포함하는 CPU 레지스터에 있는 정보
    - 메모리 제한 ( Memory Limits ) : 운영 체제에서 사용하는 메모리 관리 시스템에 대한 정보
    - 열린 파일 목록 ( List of Open File ) : 프로세스를 위해 열린 파일 목록

### Context Switching 과정

- Process P1이 실행 중이다가 Interrupt 혹은 System Call을 호출한다.

  ( Interrupt 종류 : CPU Timeout, I/O Interrupt, Network Interrupt …

  Application이 OS의 System Call을 호출한다. )

- OS가 Process1의 PCB1를 저장한다.

- Context Switch 되서 실행될 Process2의 PCB2를 가져온다.

- Process2가 실행되다가 Interrupt 혹은 System Call에 의해 Context Swith 된다.

- OS는 Process2의 PCB2를 저장하고, PCB1을 다시 로드해온다.

---

### Context Switching의 Overhead

- Context Switch를 통해 사용자에게 빠른 반응성과 동시성을 제공하지만, 실행되는 프로세스의 변경 과정에서 프로세스의 상태, 레지스터 값 등이 저장되고 불러오는 등의 작업이 수행되기에, 시스템에 많은 부담을 줌.

- CPU가 일정 시간 idle 상태에 있게 된다.

- 비용 종류
    - PCB 저장 및 복원 비용
    - CPU 캐시 메모리 무효화 비용
    - 프로세스 스케줄링 비용

- 컨텍스트 스위칭은
  비단 프로세스 뿐만 아니라, 여러 개의 스레드 끼리도 스위칭이 일어난다.
  멀티 쓰레드 환경에서, 컨텍스트 스위칭 오버헤드가 과하게 발생하면
  오히려 멀티 쓰레드가 싱글 쓰레드보다 성능이 떨어질 수도 있다.

---

스레드 스케줄링

- 운영체제에서 다중 스레드를 관리한다.
  CPU를 사용할 수 있는 스레드를 선택하고,
  CPU를 할당하는 작업을 말한다.

- 스레드 스케줄링 알고리즘은, 프로세스 스케줄링 알고리즘과 유사하게 동작한다.

  Round Robin, Priority-Based Scheduling, Multi-Level Queue Scheduling 등이 있다.

- 스레드 스케줄링은 프로세스 스케줄링과 다르게,
  스레드 간의 상호작용 및 동기화 문제를 고려해야 한다.

---

스레드 상태

- NEW : 스레드가 생성되고 아직 호출되지 않은 상태
- RUNNABLE : 스레드가 실행되기 위해 기다리는 상태
- BLOCKED : 스레드가 특정 이벤트 ( 입출력 요청 등 )가 발생하여 대기하는 상태
- TERMINATED : 스레드가 실행을 완료하고 종료된 상태, 더 이상 실행될 수 없고 메모리에서 제거됨.

---

### 스레드 컨텍스트 스위칭

- 멀티 스레딩 환경에서 스레드 간의 실행을 전환하는 기술
- 하나의 프로세스 내의 스레드들을 교환한다.

### TCB ( Thread Control Block )

- 각 스레드마다 운영체제가 유지하는 스레드에 대한 정보를 담고 있는 자료구조
- 스레드의 상태 정보, 스레드 ID, 스레드 우선순위, 스케줄링 정보 등 다양한 정보를 저장함.
- TCB도 스레드가 생성될 때, OS에 의해 생성됨.
  스레드가 실행을 마치고 소멸될 때 함께 소멸됨.

- 스레드 간 자원 공유 및 동기화도 TCB를 통해 관리됨.
- 뮤텍스(Mutual Exclusion)나 세마포어(Semaphore)와 같은 동기화 기법 사용 시,
  TCB에서 해당 스레드의 뮤텍스 / 세마포어 정보를 관리하고, 스레드가 해당 자원에 대한 접근 권한을 획득하거나 반납할 때 TCB의 정보를 업데이트함.

- 뮤텍스 - 임계 구역에 1개의 스레드만 들어갈 수 있는 동기화 기법
- 세마포어 - 임계 구역에 여러 스레드가 들어갈 수 있고, Counter를 두어 허용 가능한 스레드를 제한하는 기법

### 프로세스 컨텍스트 스위칭 vs 스레드 컨텍스트 스위칭

- 멀티테스킹 환경에서 여러 프로세스 또는 스레드를 동시에 실행하기 위한 기술이다. ( 동시성 )

다만, 다음과 같은 차이가 있다.

### 1. TCB가 PCB보다 가볍다

- 스레드 컨텍스트 스위칭이 프로세스 컨텍스트 스위칭보다 더 빠르다.
- 프로세스 내의 스레드들은 text, data, heap 영역 메모리를 공유하기에,
  TCB에는 Stack 및 간단한 Register 포인터 정보만들 저장하기에
  PCB보다 TCB가 더 가벼워 더 빨리 읽고 쓸 수 있다.

### 2. 캐시 메모리 초기화 여부

- CPU Cache Memory는 CPU와 메인 메모리 사이에 위치하며
  CPU에서 한번 이상 읽어들인 메모리의 데이터를 저장하고 있다가,
  CPU가 다시 그 메모리에 저장된 데이터를 요구할 때, 메인 메모리를 통하지 않고 바로 데이터를 전달해주는 용도이다.

- 프로세스 컨텍스트 스위칭이 일어날 경우,
  다른 프로세스의 실행으로 인해 CPU가 새로운 명령어와 데이터를 로드해야해서,
  CPU의 캐시 메모리를 초기화해야한다.

- 스레드 컨텍스트 스위칭의 경우,
  프로세스 내 스레드 간에 Stack, Register 값 등 일부 컨텍스트 정보만 변경되므로, CPU 캐시 메모리는 초기화되지 않는다.
  다만, 스레드가 다른 CPU 코어에서 실행될 때는
  해당 코어의 캐시 메모리에 스레드 컨텍스트 정보가 로드되어야 해서 초기화될 수 있다.

### 3. 자원 동기화 문제

- 스레드 컨텍스트 스위칭이 발생해
  다른 스레드가 Heap 영역의 공유 데이터에 접근할 때
  이전 스레드가 이미 공유 자원을 사용하고 있는 경우, 동기화 문제가 발생할 수 있다. 두 개의 스레드가 동시에 하나의 변수를 수정하려 할 떄, 스레드 컨텍스트 스위칭이 발생하면 변수의 값을 잘못된 값으로 업데이트할 수 있다.
  이것이 스레드 간 경쟁 조건 ( Race Condition )이다.

- 프로세스 또한, IPC와 같은 공유 자원을 사용하는 경우
  경쟁 조건이 발생할 수 있다.
  여러 프로세스가 동시에 파일 시스템에 접근하여 파일을 수정하려 할 때,
  컨텍스트 스위칭이 발생하여 다른 프로세스가 그 파일에 접근하면, 파일 내용이 손상될 수 있다.

- 적절한 공유 자원에 대한 동기화 메커니즘이 필요하다.